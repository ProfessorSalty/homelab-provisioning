#!/usr/bin/env bash

set -e

source "$(dirname "$0")/set-environment"

function main() {
  local TARGET TARGET_PATH CONTROLLER_TIMEZONE SECRETS_FILE
  
  trap 'rm -f $SECRETS_FILE' EXIT

  TARGET="$(find "$IMAGES_DIR" -type d -name "$1")"

  if [ -z "$TARGET" ]; then
    echo "There is no build configuration for $1"
    exit 1
  fi

  TARGET_PATH="$(realpath "$TARGET")"

  printf 'Running build at %s\n\n' "$TARGET_PATH"

  HOMELAB_SECRETS=$(realpath ~/.homelab-secrets.json)

  if [ -z "$HOMELAB_SECRETS" ]; then
    echo "No secrets file found. Please create $HOMELAB_SECRETS"
    exit 1
  fi

  CONTROLLER_TIMEZONE=$(cat /etc/timezone)
  SECRETS_FILE=$(mktemp --suffix ".json" -p .)

  "$BIN_FOLDER/process-json-secrets" "$HOMELAB_SECRETS" "$1" >> "$SECRETS_FILE"
  
  packer build -var="timezone=$CONTROLLER_TIMEZONE" \
    -var="template-name=$TARGET" \
    -var-file="$SECRETS_FILE" \
    "$TARGET_PATH"
}

main "$@"
