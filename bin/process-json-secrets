#!/usr/bin/env python3

import json
import sys, getopt
import re


# Take a secret type (vms or templates) and a target (the name of the thing being set up)
# and pull the secrets out from the specified file
def main(filename: str, _target: str, _secret_type: str):
    dictionaries = {
        'var': {},
        'cred': {},
        'mnt': {},
    }

    def interpolate(matches):
        interpolation_path = matches.group(0)[2:-2].strip().split('.')
        final = interpolation_path[-1]
        path = interpolation_path[:-1]
        return retrieve_values(final, path)

    def retrieve_values(final: str, path: list[str]):
        tmp_dict = dictionaries
        for p in path:
            if p not in tmp_dict:
                sys.stderr.write("Value %s not found in dictionary".format(p))
                sys.exit(2)
            tmp_dict = tmp_dict[p]
        return tmp_dict[final]

    with open(filename) as f:
        secrets_data = json.loads(f.read())
        dictionaries['var'] = secrets_data.get('variables')
        dictionaries['cred'] = secrets_data.get('credentials')
        dictionaries['mnt'] = secrets_data.get('mount_definitions')
        flat_data = {
            **secrets_data.get('proxmox',{}),
            **secrets_data.get('system',{}),
            **secrets_data.get(_secret_type).get(_target)
        }
        str_data = json.dumps(flat_data)
        interpolated_data = re.sub(r'({{.*?}})', interpolate, str_data)
        sys.stdout.write(interpolated_data)
        sys.exit(0)


if __name__ == '__main__':
    secret_type = 'vms'
    target = ''
    try:
        opts, args = getopt.getopt(sys.argv[1:], 't:s:', ['target=', 'secret-type='])
    except getopt.GetoptError as err:
        # print help information and exit:
        sys.stderr.write(err.msg)
        sys.exit(2)
    for option, argument in opts:
        if option in ['t', '--target']:
            target = argument
        elif option in ['s', '--secret-type']:
            secret_type = argument
    if target == '':
        sys.stderr.write('Need to specify a target to setup')
        sys.exit(2)
    if len(args) != 1:
        sys.stderr.write('Must specify target file')
        sys.exit(2)

    main(args[0], target, secret_type)
